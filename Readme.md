# Proxy Client

Клиент для управления XRay прокси-сервером с поддержкой VLESS/Reality протокола.

## Возможности

-  Автоматическая генерация конфигурации из VLESS URL
-  Управление процессом XRay
-  Автоматическое включение/отключение системного прокси (Windows)
-  HTTP API для управления
-  Структурированное логирование
-  Graceful shutdown
-  Потокобезопасность

## Структура проекта

```
proxyclient/
├── cmd/
│   └── proxy-client/
│       └── main.go           # Точка входа
├── internal/
│   ├── api/
│   │   └── server.go         # HTTP API сервер
│   ├── config/
│   │   ├── generator.go      # Генератор конфигурации
│   │   └── types.go          # Типы конфигурации
│   ├── logger/
│   │   └── logger.go         # Структурированный логгер
│   ├── proxy/
│   │   ├── manager.go        # Менеджер системного прокси
│   │   └── windows_proxy.go  # Реализация для Windows
│   └── xray/
│       └── manager.go        # Менеджер процесса XRay
├── config.template.json      # Шаблон конфигурации
├── secret.key               # VLESS URL (создается пользователем)
└── go.mod
```

## Установка

### Требования

- Go 1.21+
- Windows (для управления системным прокси)
- XRay Core

### Сборка

```bash
# Клонировать репозиторий
git clone <repo-url>
cd proxyclient

# Установить зависимости
go mod download

# Собрать
go build -o proxy-client.exe ./cmd/proxy-client
```

## Использование

### 1. Подготовка

Создайте файл `secret.key` с вашим VLESS URL:

```
vless://uuid@server:port?sni=example.com&pbk=publickey&sid=shortid
```

### 2. Запуск

```bash
./proxy-client.exe
```

Программа автоматически:
1. Сгенерирует конфигурацию из `secret.key`
2. Включит системный прокси
3. Запустит XRay
4. Запустит API сервер на порту 8080

### 3. API Endpoints

#### Получить статус

```bash
GET http://localhost:8080/api/status
```

Ответ:
```json
{
  "xray": {
    "running": true,
    "pid": 12345
  },
  "proxy": {
    "enabled": true,
    "address": "127.0.0.1:10807"
  },
  "config_path": "config.runtime.json"
}
```

#### Включить прокси

```bash
POST http://localhost:8080/api/proxy/enable
```

#### Отключить прокси

```bash
POST http://localhost:8080/api/proxy/disable
```

#### Проверка здоровья

```bash
GET http://localhost:8080/api/health
```

## Архитектура

### Основные компоненты

#### 1. Logger
Структурированный логгер с уровнями логирования:
- DEBUG
- INFO
- WARN
- ERROR

#### 2. Config Generator
- Парсит VLESS URL
- Валидирует параметры
- Генерирует конфигурацию XRay

#### 3. XRay Manager
- Управление жизненным циклом процесса
- Graceful shutdown (5 секунд на завершение, затем KILL)
- Мониторинг состояния процесса
- Потокобезопасный доступ

#### 4. Proxy Manager
- Управление системным прокси Windows
- Включение/отключение через реестр
- Уведомление системы об изменениях

#### 5. API Server
- RESTful API
- Middleware для логирования
- Middleware для обработки паник
- Graceful shutdown

## Улучшения по сравнению с оригиналом

### 1. Обработка ошибок
-  Было: Ошибки игнорировались с пустыми `defer`
-  Стало: Все ошибки обрабатываются и логируются

### 2. Архитектура
-  Было: Жёсткая связанность, прямой доступ к полям
-  Стало: Интерфейсы, инверсия зависимостей, инкапсуляция

### 3. Graceful Shutdown
-  Было: Прямой Kill процесса
-  Стало: Мягкое завершение с таймаутом, затем Kill

### 4. Потокобезопасность
-  Было: Нет защиты от гонок
-  Стало: RWMutex для всех shared state

### 5. Логирование
-  Было: `fmt.Println` и `log.Fatal`
-  Стало: Структурированный логгер с уровнями

### 6. Валидация
-  Было: Минимальная проверка входных данных
-  Стало: Полная валидация конфигурации и параметров

### 7. API
-  Было: Ошибки в логике, проблемы с nil
-  Стало: Правильная обработка состояний, middleware

### 8. Тестируемость
-  Было: Невозможно протестировать
-  Стало: Интерфейсы, dependency injection

## Конфигурация

### config.template.json

Шаблон конфигурации XRay. Поля с `YOUR_*` будут автоматически заменены на значения из VLESS URL.

### Переменные окружения (опционально)

```bash
# Порт API сервера (по умолчанию :8080)
API_PORT=:8080

# Уровень логирования (debug, info, warn, error)
LOG_LEVEL=info
```

## Примеры использования

### Проверка статуса через curl

```bash
curl http://localhost:8080/api/status | jq
```

### Управление прокси

```bash
# Отключить
curl -X POST http://localhost:8080/api/proxy/disable

# Включить
curl -X POST http://localhost:8080/api/proxy/enable
```

## Устранение неполадок

### XRay не запускается

1. Проверьте путь к исполняемому файлу
2. Проверьте корректность `secret.key`
3. Проверьте логи

### Системный прокси не включается

1. Запустите с правами администратора
2. Проверьте, не блокирует ли антивирус
3. Проверьте логи Windows Event Viewer

### API недоступен

1. Проверьте, не занят ли порт 8080
2. Проверьте firewall
3. Попробуйте изменить порт

## Разработка

### Запуск в режиме разработки

```bash
go run ./cmd/proxy-client/main.go
```

### Тесты

```bash
go test ./...
```

### Линтер

```bash
golangci-lint run
```

## Лицензия

MIT

## TODO

-  Поддержка Linux/macOS
-  Конфигурация через YAML
-  Метрики (Prometheus)
-  Web UI
-  Автоматическое обновление XRay
-  Поддержка множественных профилей
-  Системный трей интеграция
